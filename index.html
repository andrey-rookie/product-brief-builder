<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Product Brief Builder</title>
  <style>
    :root {
      --bg: #171a1f;
      --paper: #232933;
      --ink: #e8edf6;
      --muted: #a8b2c2;
      --accent: #5f819d;
      --accent-soft: rgba(95, 129, 157, 0.28);
      --line: #394556;
      --danger: #d9796c;
      --radius: 14px;
      --shadow: 0 14px 40px rgba(0, 0, 0, 0.35);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Avenir Next", "Montserrat", "Segoe UI", sans-serif;
      color: var(--ink);
      background:
        radial-gradient(circle at 12% 8%, rgba(96, 108, 128, 0.22), transparent 38%),
        radial-gradient(circle at 88% 4%, rgba(68, 76, 92, 0.28), transparent 32%),
        linear-gradient(145deg, #111418 0%, #1a1f26 48%, #222833 100%);
    }

    .container {
      width: min(1040px, 92vw);
      margin: 32px auto 80px;
    }

    .hero {
      background: linear-gradient(135deg, #27303d, #202734);
      border: 1px solid var(--line);
      border-radius: 20px;
      box-shadow: var(--shadow);
      padding: 28px;
      margin-bottom: 24px;
    }

    h1 {
      margin: 0 0 8px;
      font-size: clamp(1.6rem, 2.8vw, 2.4rem);
      letter-spacing: -0.02em;
    }

    .subtitle {
      margin: 0;
      color: var(--muted);
      line-height: 1.45;
      max-width: 80ch;
    }

    .card {
      background: var(--paper);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 18px;
      margin-bottom: 16px;
    }

    .card h2, .card h3 {
      margin: 0 0 14px;
      letter-spacing: -0.01em;
    }

    .grid {
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(2, minmax(220px, 1fr));
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .field.wide {
      grid-column: 1 / -1;
    }

    label {
      font-size: 0.9rem;
      color: var(--muted);
      font-weight: 600;
    }

    input, textarea {
      width: 100%;
      border: 1px solid #425166;
      border-radius: 10px;
      padding: 10px 12px;
      font: inherit;
      color: var(--ink);
      background: #1b212b;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    input::placeholder, textarea::placeholder {
      color: #8e9ab0;
    }

    input:focus, textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-soft);
      outline: none;
    }

    textarea {
      min-height: 88px;
      resize: vertical;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-top: 8px;
    }

    button {
      border: 1px solid transparent;
      border-radius: 999px;
      padding: 10px 14px;
      font: inherit;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.08s ease, background-color 0.2s ease, border-color 0.2s ease;
    }

    button:active {
      transform: translateY(1px);
    }

    .btn-primary {
      background: var(--accent);
      color: #fff;
    }

    .btn-muted {
      background: #2f3847;
      color: #d6deeb;
      border-color: #455367;
    }

    .btn-danger {
      background: #3b2830;
      color: var(--danger);
      border-color: #6d4a53;
    }

    .modules {
      display: grid;
      gap: 12px;
      margin-top: 14px;
    }

    .module {
      border: 1px solid #415064;
      border-radius: 12px;
      padding: 14px;
      background: #1f2631;
    }

    .module-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 8px;
    }

    .module-head h4 {
      margin: 0;
      font-size: 1rem;
    }

    .module-head-actions {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .module.collapsed .module-body {
      display: none;
    }

    .module.collapsed {
      padding-bottom: 10px;
    }

    .feature {
      border-left: 3px solid #4d5d73;
      padding-left: 10px;
      margin-top: 10px;
    }

    .feature-head, .scenario-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 8px;
    }

    .feature-head h5, .scenario-head h6 {
      margin: 0;
      color: var(--ink);
      font-size: 0.96rem;
      font-weight: 700;
    }

    .feature-head-actions, .scenario-head-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    .feature.collapsed .feature-body {
      display: none;
    }

    .scenario.collapsed .scenario-body {
      display: none;
    }

    .scenarios {
      margin-top: 8px;
      display: grid;
      gap: 8px;
    }

    .scenario {
      border: 1px solid #3f4d61;
      border-radius: 10px;
      background: #1a2029;
      padding: 10px;
    }

    .feature-controls {
      margin-top: 6px;
    }

    .status {
      color: var(--muted);
      font-size: 0.9rem;
      margin-top: 6px;
    }

    .actions {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 14px;
    }

    @media (max-width: 760px) {
      .grid {
        grid-template-columns: 1fr;
      }

      .module-head {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <section class="hero">
      <h1>Внутренний бриф для IT-продуктов</h1>
      <p class="subtitle">
        Заполняй базовые бизнес-вопросы, добавляй модули и функционал, фиксируй сквозные техтребования.
        В конце экспортируй документ (`.md` + `.json`) и загружай его в ChatGPT/Codex для максимально релевантной разработки.
      </p>
    </section>

    <section class="card">
      <h2>1) Бизнес-контекст</h2>
      <div class="grid">
        <div class="field">
          <label for="productName">Название продукта</label>
          <input id="productName" placeholder="Например: Partner Portal">
        </div>
        <div class="field">
          <label for="owner">Ответственный</label>
          <input id="owner" placeholder="Имя / команда">
        </div>
        <div class="field wide">
          <label for="problem">Какую проблему решаем</label>
          <textarea id="problem" placeholder="Что сейчас не работает и почему это важно"></textarea>
        </div>
        <div class="field wide">
          <label for="audience">Целевая аудитория</label>
          <textarea id="audience" placeholder="Кто пользователь, сегменты, роли"></textarea>
        </div>
        <div class="field wide">
          <label for="goals">Ключевые бизнес-цели / KPI</label>
          <textarea id="goals" placeholder="Например: снизить CAC, ускорить onboarding, увеличить retention"></textarea>
        </div>
        <div class="field wide">
          <label for="constraints">Ограничения</label>
          <textarea id="constraints" placeholder="Сроки, бюджет, легаси, compliance"></textarea>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>2) Роли и права</h2>
      <div class="grid">
        <div class="field wide">
          <label for="systemRoles">Роли системы</label>
          <textarea id="systemRoles" placeholder="Admin, Manager, Analyst, User и т.д."></textarea>
        </div>
        <div class="field wide">
          <label for="rolePermissions">Доступы по ролям</label>
          <textarea id="rolePermissions" placeholder="Какая роль какие модули/действия может выполнять"></textarea>
        </div>
        <div class="field wide">
          <label for="actionRestrictions">Ограничения действий</label>
          <textarea id="actionRestrictions" placeholder="Что запрещено, лимиты, запреты по состояниям"></textarea>
        </div>
        <div class="field wide">
          <label for="dataOwnership">Ownership данных</label>
          <textarea id="dataOwnership" placeholder="Кто владелец сущностей и кто может менять/удалять"></textarea>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>3) User Journey (верхний UX-слой)</h2>
      <div class="grid">
        <div class="field wide">
          <label for="entryPoints">Вход в продукт</label>
          <textarea id="entryPoints" placeholder="Откуда приходит пользователь: лендинг, direct, invite, marketplace"></textarea>
        </div>
        <div class="field wide">
          <label for="onboardingFlow">Onboarding</label>
          <textarea id="onboardingFlow" placeholder="Первые шаги после входа: регистрация, настройка, импорт данных"></textarea>
        </div>
        <div class="field wide">
          <label for="firstValue">Первая ценность (Time to Value)</label>
          <textarea id="firstValue" placeholder="Когда пользователь впервые получает заметную пользу"></textarea>
        </div>
        <div class="field wide">
          <label for="returningFlow">Повторный визит</label>
          <textarea id="returningFlow" placeholder="Зачем пользователь возвращается и что делает регулярно"></textarea>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>4) Сквозные технические вводные</h2>
      <div class="grid">
        <div class="field wide">
          <label for="architecture">Архитектурные требования</label>
          <textarea id="architecture" placeholder="Монолит/микросервисы, API-first, event-driven и т.д."></textarea>
        </div>
        <div class="field wide">
          <label for="integrations">Интеграции и внешние системы</label>
          <textarea id="integrations" placeholder="CRM, платежи, SSO, аналитика, email-провайдеры"></textarea>
        </div>
        <div class="field wide">
          <label for="crossFunctions">Общие функции над модулями</label>
          <textarea id="crossFunctions" placeholder="Роли/доступы, логирование, аудит, нотификации, отчеты"></textarea>
        </div>
        <div class="field wide">
          <label for="nonFunctional">Нефункциональные требования</label>
          <textarea id="nonFunctional" placeholder="SLA/SLO, безопасность, производительность, отказоустойчивость"></textarea>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>5) Состояния, события, данные, метрики и экономика</h2>
      <div class="grid">
        <div class="field wide">
          <label for="systemStates">Состояния системы и объектов</label>
          <textarea id="systemStates" placeholder="Статусы сущностей, FSM-процессы, переходы, rollback"></textarea>
        </div>
        <div class="field wide">
          <label for="eventsTriggers">События и триггеры</label>
          <textarea id="eventsTriggers" placeholder="Какие события публикуются, кто подписан, какие автоматизации запускаются"></textarea>
        </div>
        <div class="field wide">
          <label for="productMetrics">Продуктовые метрики</label>
          <textarea id="productMetrics" placeholder="Activation, Retention, Core Action, unit-метрики по модулям"></textarea>
        </div>
        <div class="field wide">
          <label for="economics">Экономика продукта</label>
          <textarea id="economics" placeholder="Монетизация, pricing, cost drivers, лимиты"></textarea>
        </div>
        <div class="field wide">
          <label for="dataEntities">Ключевые сущности (Entities)</label>
          <textarea id="dataEntities" placeholder="Перечень сущностей: User, Account, Subscription, Invoice и т.д."></textarea>
        </div>
        <div class="field wide">
          <label for="dataRelations">Связи данных (Relations)</label>
          <textarea id="dataRelations" placeholder="Ключевые связи между сущностями: один-ко-многим, многие-ко-многим"></textarea>
        </div>
        <div class="field wide">
          <label for="dataConstraints">Ограничения данных (Constraints)</label>
          <textarea id="dataConstraints" placeholder="Уникальность, обязательные поля, ограничения обновления/удаления, консистентность"></textarea>
        </div>
        <div class="field wide">
          <label for="edgeCases">Edge cases и сбои</label>
          <textarea id="edgeCases" placeholder="Отказ интеграции, отмена действий, дубликаты, race conditions"></textarea>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>6) Модули продукта</h2>
      <div class="row">
        <button id="addModule" class="btn-primary" type="button">+ Добавить модуль</button>
        <button id="saveDraft" class="btn-muted" type="button">Сохранить черновик</button>
        <button id="loadDraft" class="btn-muted" type="button">Восстановить черновик</button>
        <button id="clearAll" class="btn-danger" type="button">Очистить форму</button>
      </div>
      <p class="status" id="status"></p>
      <div class="modules" id="modules"></div>
    </section>

    <section class="card">
      <h2>7) Экспорт брифа</h2>
      <p class="subtitle">Экспортируй документ и потом загружай его в ChatGPT/Codex как контекст для разработки.</p>
      <div class="actions">
        <button id="exportMd" class="btn-primary" type="button">Скачать .md</button>
        <button id="exportJson" class="btn-muted" type="button">Скачать .json</button>
      </div>
    </section>
  </div>

  <template id="moduleTemplate">
    <article class="module">
      <div class="module-head">
        <h4>Новый модуль</h4>
        <div class="module-head-actions">
          <button type="button" class="btn-muted module-toggle">Свернуть модуль</button>
          <button type="button" class="btn-danger module-remove">Удалить модуль</button>
        </div>
      </div>
      <div class="module-body">
        <div class="grid">
          <div class="field">
            <label>Название модуля</label>
            <input class="module-title" placeholder="Например: Billing">
          </div>
          <div class="field wide">
            <label>Ценность модуля</label>
            <textarea class="module-purpose" placeholder="Какую ценность дает модуль пользователю/бизнесу"></textarea>
          </div>
        </div>
        <div class="row">
          <button type="button" class="btn-muted module-add-feature">+ Добавить функционал</button>
        </div>
        <div class="features"></div>
      </div>
    </article>
  </template>

  <template id="featureTemplate">
    <div class="feature">
      <div class="feature-head">
        <h5>Новый функционал</h5>
        <div class="feature-head-actions">
          <button type="button" class="btn-muted feature-toggle">Свернуть функционал</button>
          <button type="button" class="btn-danger feature-remove">Удалить функционал</button>
        </div>
      </div>
      <div class="feature-body">
        <div class="field">
          <label>Функционал</label>
          <input class="feature-name" placeholder="Например: Подписка, выставление счета">
        </div>
        <div class="field">
          <label>Бизнес-результат</label>
          <textarea class="feature-business" placeholder="Какой конкретный результат дает эта функция"></textarea>
        </div>
        <div class="field">
          <label>Acceptance Criteria</label>
          <textarea class="feature-criteria" placeholder="- Критерий 1&#10;- Критерий 2&#10;- Критерий 3"></textarea>
        </div>
        <div class="feature-controls">
          <button type="button" class="btn-muted feature-add-scenario">+ Добавить пользовательский сценарий</button>
        </div>
        <div class="scenarios"></div>
      </div>
    </div>
  </template>

  <template id="scenarioTemplate">
    <div class="scenario">
      <div class="scenario-head">
        <h6>Новый сценарий</h6>
        <div class="scenario-head-actions">
          <button type="button" class="btn-muted scenario-toggle">Свернуть сценарий</button>
          <button type="button" class="btn-danger scenario-remove">Удалить сценарий</button>
        </div>
      </div>
      <div class="scenario-body">
        <div class="field">
          <label>Actor</label>
          <input class="scenario-actor" placeholder="Кто выполняет сценарий: пользователь, менеджер, админ">
        </div>
        <div class="field">
          <label>Шаги</label>
          <textarea class="scenario-steps" placeholder="1) Шаг 1&#10;2) Шаг 2&#10;3) Шаг 3"></textarea>
        </div>
        <div class="field">
          <label>Ожидаемый результат</label>
          <textarea class="scenario-result" placeholder="Что пользователь получает в конце сценария"></textarea>
        </div>
        <div class="field">
          <label>Альтернативный путь / исключения</label>
          <textarea class="scenario-alt" placeholder="Что происходит при ошибках, отклонениях или альтернативном выборе"></textarea>
        </div>
      </div>
    </div>
  </template>

  <script>
    const modulesEl = document.getElementById("modules");
    const statusEl = document.getElementById("status");
    const draftKey = "product-brief-draft-v2";

    const controls = {
      productName: document.getElementById("productName"),
      owner: document.getElementById("owner"),
      problem: document.getElementById("problem"),
      audience: document.getElementById("audience"),
      goals: document.getElementById("goals"),
      constraints: document.getElementById("constraints"),
      systemRoles: document.getElementById("systemRoles"),
      rolePermissions: document.getElementById("rolePermissions"),
      actionRestrictions: document.getElementById("actionRestrictions"),
      dataOwnership: document.getElementById("dataOwnership"),
      entryPoints: document.getElementById("entryPoints"),
      onboardingFlow: document.getElementById("onboardingFlow"),
      firstValue: document.getElementById("firstValue"),
      returningFlow: document.getElementById("returningFlow"),
      architecture: document.getElementById("architecture"),
      integrations: document.getElementById("integrations"),
      crossFunctions: document.getElementById("crossFunctions"),
      nonFunctional: document.getElementById("nonFunctional"),
      systemStates: document.getElementById("systemStates"),
      eventsTriggers: document.getElementById("eventsTriggers"),
      productMetrics: document.getElementById("productMetrics"),
      economics: document.getElementById("economics"),
      dataEntities: document.getElementById("dataEntities"),
      dataRelations: document.getElementById("dataRelations"),
      dataConstraints: document.getElementById("dataConstraints"),
      edgeCases: document.getElementById("edgeCases")
    };

    function setStatus(text) {
      statusEl.textContent = text;
    }

    function toNumberedList(text) {
      if (!text) return "";
      const lines = text.split("\n").map((line) => line.trim()).filter(Boolean);
      return lines.map((line, index) => {
        const stripped = line.replace(/^\d+[.)]\s+/, "");
        return `${index + 1}) ${stripped}`;
      }).join("\n");
    }

    function toBulletedList(text) {
      if (!text) return "";
      const lines = text.split("\n").map((line) => line.trim()).filter(Boolean);
      return lines.map((line) => {
        const stripped = line.replace(/^[-*]\s+/, "");
        return `- ${stripped}`;
      }).join("\n");
    }

    function updateScenarioHeadline(scenarioEl) {
      const actor = scenarioEl.querySelector(".scenario-actor").value.trim();
      const result = scenarioEl.querySelector(".scenario-result").value.trim();
      const raw = [actor, result].filter(Boolean).join(" -> ");
      const oneLine = raw.replace(/\s+/g, " ");
      scenarioEl.querySelector("h6").textContent = oneLine ? oneLine.slice(0, 72) : "Новый сценарий";
    }

    function setScenarioCollapsed(scenarioEl, collapsed) {
      scenarioEl.classList.toggle("collapsed", collapsed);
      scenarioEl.querySelector(".scenario-toggle").textContent = collapsed ? "Развернуть сценарий" : "Свернуть сценарий";
    }

    function addScenario(featureEl, data = {}) {
      const tpl = document.getElementById("scenarioTemplate");
      const scenarioEl = tpl.content.firstElementChild.cloneNode(true);
      scenarioEl.querySelector(".scenario-actor").value = data.actor || "";
      scenarioEl.querySelector(".scenario-steps").value = data.steps || data.text || "";
      scenarioEl.querySelector(".scenario-result").value = data.result || "";
      scenarioEl.querySelector(".scenario-alt").value = data.alternativePath || "";
      updateScenarioHeadline(scenarioEl);
      scenarioEl.querySelector(".scenario-actor").addEventListener("input", () => updateScenarioHeadline(scenarioEl));
      scenarioEl.querySelector(".scenario-result").addEventListener("input", () => updateScenarioHeadline(scenarioEl));
      scenarioEl.querySelector(".scenario-steps").addEventListener("blur", () => {
        const current = scenarioEl.querySelector(".scenario-steps").value.trim();
        if (current) {
          scenarioEl.querySelector(".scenario-steps").value = toNumberedList(current);
        }
      });
      scenarioEl.querySelector(".scenario-toggle").addEventListener("click", () => {
        const collapsed = !scenarioEl.classList.contains("collapsed");
        setScenarioCollapsed(scenarioEl, collapsed);
      });
      scenarioEl.querySelector(".scenario-remove").addEventListener("click", () => {
        scenarioEl.remove();
      });
      setScenarioCollapsed(scenarioEl, Boolean(data.collapsed));
      featureEl.querySelector(".scenarios").appendChild(scenarioEl);
    }

    function updateFeatureHeadline(featureEl) {
      const name = featureEl.querySelector(".feature-name").value.trim();
      const business = featureEl.querySelector(".feature-business").value.trim().replace(/\s+/g, " ");
      const marker = business ? ` -> ${business.slice(0, 28)}` : "";
      featureEl.querySelector("h5").textContent = (name || "Новый функционал") + marker;
    }

    function setFeatureCollapsed(featureEl, collapsed) {
      featureEl.classList.toggle("collapsed", collapsed);
      featureEl.querySelector(".feature-toggle").textContent = collapsed ? "Развернуть функционал" : "Свернуть функционал";
    }

    function addFeature(moduleEl, data = {}) {
      const tpl = document.getElementById("featureTemplate");
      const feature = tpl.content.firstElementChild.cloneNode(true);
      feature.querySelector(".feature-name").value = data.name || "";
      feature.querySelector(".feature-business").value = data.businessResult || data.description || "";
      feature.querySelector(".feature-criteria").value = data.acceptanceCriteria || "";
      updateFeatureHeadline(feature);
      feature.querySelector(".feature-name").addEventListener("input", () => updateFeatureHeadline(feature));
      feature.querySelector(".feature-business").addEventListener("input", () => updateFeatureHeadline(feature));
      feature.querySelector(".feature-criteria").addEventListener("blur", () => {
        const current = feature.querySelector(".feature-criteria").value.trim();
        if (current) {
          feature.querySelector(".feature-criteria").value = toBulletedList(current);
        }
      });
      feature.querySelector(".feature-toggle").addEventListener("click", () => {
        const collapsed = !feature.classList.contains("collapsed");
        setFeatureCollapsed(feature, collapsed);
      });
      feature.querySelector(".feature-add-scenario").addEventListener("click", () => addScenario(feature));
      feature.querySelector(".feature-remove").addEventListener("click", () => {
        feature.remove();
      });
      if (Array.isArray(data.scenarios)) {
        data.scenarios.forEach((scenario) => addScenario(feature, scenario));
      }
      setFeatureCollapsed(feature, Boolean(data.collapsed));
      moduleEl.querySelector(".features").appendChild(feature);
    }

    function updateModuleHeadline(moduleEl) {
      const value = moduleEl.querySelector(".module-title").value.trim();
      moduleEl.querySelector("h4").textContent = value || "Новый модуль";
    }

    function setModuleCollapsed(moduleEl, collapsed) {
      moduleEl.classList.toggle("collapsed", collapsed);
      moduleEl.querySelector(".module-toggle").textContent = collapsed ? "Развернуть модуль" : "Свернуть модуль";
    }

    function addModule(data = {}) {
      const tpl = document.getElementById("moduleTemplate");
      const moduleEl = tpl.content.firstElementChild.cloneNode(true);
      moduleEl.querySelector(".module-title").value = data.title || "";
      moduleEl.querySelector(".module-purpose").value = data.value || data.purpose || "";
      updateModuleHeadline(moduleEl);

      moduleEl.querySelector(".module-title").addEventListener("input", () => updateModuleHeadline(moduleEl));
      moduleEl.querySelector(".module-toggle").addEventListener("click", () => {
        const collapsed = !moduleEl.classList.contains("collapsed");
        setModuleCollapsed(moduleEl, collapsed);
      });
      moduleEl.querySelector(".module-remove").addEventListener("click", () => moduleEl.remove());
      moduleEl.querySelector(".module-add-feature").addEventListener("click", () => addFeature(moduleEl));

      if (Array.isArray(data.features)) {
        data.features.forEach((feature) => addFeature(moduleEl, feature));
      }
      setModuleCollapsed(moduleEl, Boolean(data.collapsed));
      modulesEl.appendChild(moduleEl);
    }

    function collectData() {
      const modules = [...modulesEl.querySelectorAll(".module")].map((moduleEl) => ({
        title: moduleEl.querySelector(".module-title").value.trim(),
        value: moduleEl.querySelector(".module-purpose").value.trim(),
        collapsed: moduleEl.classList.contains("collapsed"),
        features: [...moduleEl.querySelectorAll(".feature")].map((featureEl) => ({
          name: featureEl.querySelector(".feature-name").value.trim(),
          businessResult: featureEl.querySelector(".feature-business").value.trim(),
          acceptanceCriteria: featureEl.querySelector(".feature-criteria").value.trim(),
          collapsed: featureEl.classList.contains("collapsed"),
          scenarios: [...featureEl.querySelectorAll(".scenario")].map((scenarioEl) => ({
            actor: scenarioEl.querySelector(".scenario-actor").value.trim(),
            steps: scenarioEl.querySelector(".scenario-steps").value.trim(),
            result: scenarioEl.querySelector(".scenario-result").value.trim(),
            alternativePath: scenarioEl.querySelector(".scenario-alt").value.trim(),
            collapsed: scenarioEl.classList.contains("collapsed")
          })).filter((s) => s.actor || s.steps || s.result || s.alternativePath)
        })).filter((f) => f.name || f.businessResult || f.acceptanceCriteria || f.scenarios.length)
      })).filter((m) => m.title || m.value || m.features.length);

      return {
        meta: {
          createdAt: new Date().toISOString()
        },
        business: {
          productName: controls.productName.value.trim(),
          owner: controls.owner.value.trim(),
          problem: controls.problem.value.trim(),
          audience: controls.audience.value.trim(),
          goals: controls.goals.value.trim(),
          constraints: controls.constraints.value.trim()
        },
        rolesAccess: {
          systemRoles: controls.systemRoles.value.trim(),
          rolePermissions: controls.rolePermissions.value.trim(),
          actionRestrictions: controls.actionRestrictions.value.trim(),
          dataOwnership: controls.dataOwnership.value.trim()
        },
        userJourney: {
          entryPoints: controls.entryPoints.value.trim(),
          onboardingFlow: controls.onboardingFlow.value.trim(),
          firstValue: controls.firstValue.value.trim(),
          returningFlow: controls.returningFlow.value.trim()
        },
        technical: {
          architecture: controls.architecture.value.trim(),
          integrations: controls.integrations.value.trim(),
          crossFunctions: controls.crossFunctions.value.trim(),
          nonFunctional: controls.nonFunctional.value.trim()
        },
        productSystem: {
          systemStates: controls.systemStates.value.trim(),
          eventsTriggers: controls.eventsTriggers.value.trim(),
          productMetrics: controls.productMetrics.value.trim(),
          economics: controls.economics.value.trim(),
          dataEntities: controls.dataEntities.value.trim(),
          dataRelations: controls.dataRelations.value.trim(),
          dataConstraints: controls.dataConstraints.value.trim(),
          edgeCases: controls.edgeCases.value.trim()
        },
        modules
      };
    }

    function hydrateData(data) {
      if (!data || typeof data !== "object") return;
      controls.productName.value = data.business?.productName || "";
      controls.owner.value = data.business?.owner || "";
      controls.problem.value = data.business?.problem || "";
      controls.audience.value = data.business?.audience || "";
      controls.goals.value = data.business?.goals || "";
      controls.constraints.value = data.business?.constraints || "";
      controls.systemRoles.value = data.rolesAccess?.systemRoles || "";
      controls.rolePermissions.value = data.rolesAccess?.rolePermissions || "";
      controls.actionRestrictions.value = data.rolesAccess?.actionRestrictions || "";
      controls.dataOwnership.value = data.rolesAccess?.dataOwnership || "";
      controls.entryPoints.value = data.userJourney?.entryPoints || "";
      controls.onboardingFlow.value = data.userJourney?.onboardingFlow || "";
      controls.firstValue.value = data.userJourney?.firstValue || "";
      controls.returningFlow.value = data.userJourney?.returningFlow || "";
      controls.architecture.value = data.technical?.architecture || "";
      controls.integrations.value = data.technical?.integrations || "";
      controls.crossFunctions.value = data.technical?.crossFunctions || "";
      controls.nonFunctional.value = data.technical?.nonFunctional || "";
      controls.systemStates.value = data.productSystem?.systemStates || "";
      controls.eventsTriggers.value = data.productSystem?.eventsTriggers || "";
      controls.productMetrics.value = data.productSystem?.productMetrics || "";
      controls.economics.value = data.productSystem?.economics || "";
      controls.dataEntities.value = data.productSystem?.dataEntities || data.productSystem?.dataModel || "";
      controls.dataRelations.value = data.productSystem?.dataRelations || "";
      controls.dataConstraints.value = data.productSystem?.dataConstraints || "";
      controls.edgeCases.value = data.productSystem?.edgeCases || "";

      modulesEl.innerHTML = "";
      (data.modules || []).forEach((m) => addModule(m));
    }

    function saveDraft() {
      const payload = collectData();
      localStorage.setItem(draftKey, JSON.stringify(payload));
      setStatus("Черновик сохранен локально в браузере.");
    }

    function loadDraft() {
      const raw = localStorage.getItem(draftKey);
      if (!raw) {
        setStatus("Черновик не найден.");
        return;
      }
      try {
        const data = JSON.parse(raw);
        hydrateData(data);
        setStatus("Черновик восстановлен.");
      } catch {
        setStatus("Не удалось прочитать черновик.");
      }
    }

    function clearAll() {
      Object.values(controls).forEach((el) => {
        el.value = "";
      });
      modulesEl.innerHTML = "";
      setStatus("Форма очищена.");
    }

    function toMarkdown(data) {
      const lines = [];
      lines.push("# Product Brief");
      lines.push("");
      lines.push(`Дата генерации: ${new Date(data.meta.createdAt).toLocaleString("ru-RU")}`);
      lines.push("");
      lines.push("## 1. Бизнес-контекст");
      lines.push(`- Название продукта: ${data.business.productName || "-"}`);
      lines.push(`- Ответственный: ${data.business.owner || "-"}`);
      lines.push(`- Проблема: ${data.business.problem || "-"}`);
      lines.push(`- Целевая аудитория: ${data.business.audience || "-"}`);
      lines.push(`- KPI/цели: ${data.business.goals || "-"}`);
      lines.push(`- Ограничения: ${data.business.constraints || "-"}`);
      lines.push("");
      lines.push("## 2. Роли и права");
      lines.push(`- Роли системы: ${data.rolesAccess?.systemRoles || "-"}`);
      lines.push(`- Доступы по ролям: ${data.rolesAccess?.rolePermissions || "-"}`);
      lines.push(`- Ограничения действий: ${data.rolesAccess?.actionRestrictions || "-"}`);
      lines.push(`- Ownership данных: ${data.rolesAccess?.dataOwnership || "-"}`);
      lines.push("");
      lines.push("## 3. User Journey");
      lines.push(`- Вход в продукт: ${data.userJourney?.entryPoints || "-"}`);
      lines.push(`- Onboarding: ${data.userJourney?.onboardingFlow || "-"}`);
      lines.push(`- Первая ценность: ${data.userJourney?.firstValue || "-"}`);
      lines.push(`- Повторный визит: ${data.userJourney?.returningFlow || "-"}`);
      lines.push("");
      lines.push("## 4. Сквозные технические вводные");
      lines.push(`- Архитектурные требования: ${data.technical.architecture || "-"}`);
      lines.push(`- Интеграции: ${data.technical.integrations || "-"}`);
      lines.push(`- Общие функции: ${data.technical.crossFunctions || "-"}`);
      lines.push(`- Нефункциональные требования: ${data.technical.nonFunctional || "-"}`);
      lines.push("");
      lines.push("## 5. Состояния, события, данные, метрики, экономика");
      lines.push(`- Состояния системы/FSM: ${data.productSystem?.systemStates || "-"}`);
      lines.push(`- События и триггеры: ${data.productSystem?.eventsTriggers || "-"}`);
      lines.push(`- Продуктовые метрики: ${data.productSystem?.productMetrics || "-"}`);
      lines.push(`- Экономика: ${data.productSystem?.economics || "-"}`);
      lines.push(`- Сущности данных: ${data.productSystem?.dataEntities || data.productSystem?.dataModel || "-"}`);
      lines.push(`- Связи данных: ${data.productSystem?.dataRelations || "-"}`);
      lines.push(`- Ограничения данных: ${data.productSystem?.dataConstraints || "-"}`);
      lines.push(`- Edge cases: ${data.productSystem?.edgeCases || "-"}`);
      lines.push("");
      lines.push("## 6. Модули");
      if (!data.modules.length) {
        lines.push("- Модули не добавлены");
      } else {
        data.modules.forEach((module, i) => {
          lines.push(`### ${i + 1}. ${module.title || "Без названия"}`);
          lines.push(`Ценность модуля: ${module.value || "-"}`);
          lines.push("");
          lines.push("Функционал:");
          if (!module.features.length) {
            lines.push("- Не указан");
          } else {
            module.features.forEach((f) => {
              lines.push(`- ${f.name || "Без названия"}`);
              lines.push(`  Бизнес-результат: ${f.businessResult || f.description || "-"}`);
              lines.push(`  Acceptance Criteria: ${f.acceptanceCriteria || "-"}`);
              if (Array.isArray(f.scenarios) && f.scenarios.length) {
                lines.push("  Пользовательские сценарии:");
                f.scenarios.forEach((scenario, sIndex) => {
                  lines.push(`  ${sIndex + 1}) Actor: ${scenario.actor || "-"}`);
                  lines.push(`     Шаги: ${scenario.steps || scenario.text || "-"}`);
                  lines.push(`     Результат: ${scenario.result || "-"}`);
                  lines.push(`     Альтернативный путь: ${scenario.alternativePath || "-"}`);
                });
              }
            });
          }
          lines.push("");
        });
      }
      return lines.join("\n");
    }

    function slugify(value) {
      return (value || "product-brief")
        .toLowerCase()
        .trim()
        .replace(/[^a-z0-9а-яё]+/gi, "-")
        .replace(/(^-|-$)/g, "");
    }

    function download(filename, content, type) {
      const blob = new Blob([content], { type });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    document.getElementById("addModule").addEventListener("click", () => addModule());
    document.getElementById("saveDraft").addEventListener("click", saveDraft);
    document.getElementById("loadDraft").addEventListener("click", loadDraft);
    document.getElementById("clearAll").addEventListener("click", clearAll);

    document.getElementById("exportMd").addEventListener("click", () => {
      const data = collectData();
      const name = slugify(data.business.productName);
      download(`${name}.md`, toMarkdown(data), "text/markdown;charset=utf-8");
      setStatus("Markdown-файл скачан.");
    });

    document.getElementById("exportJson").addEventListener("click", () => {
      const data = collectData();
      const name = slugify(data.business.productName);
      download(`${name}.json`, JSON.stringify(data, null, 2), "application/json;charset=utf-8");
      setStatus("JSON-файл скачан.");
    });
  </script>
</body>
</html>
